{% extends 'shared/layout.html' %}

{% block extracss %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/chat.css') }}">
{% endblock %}

{% block maincontent %}
<div class="container" style="margin-top: 60px;" id="centralDivLanding">
  <div class="heading1"><br><br><br><br>
    <h2><center>ğŸ¬ PopcornPicksğŸ¿: Chat with others about Movies! ğŸ¬</center></h2>
  </div>
  
  <!-- Current Username Display -->
  <div class="alert alert-info text-center mt-3" role="alert">
    <strong>Current Username: {{ user }}</strong>
  </div>
  
  <div class="d-flex">
    <!-- Chat Box -->
    <div class="card d-flex flex-column flex-grow-1 me-3">
      <div class="card-header text-secondary">
        Live Movie Chat
      </div>
      <ul id="message_list" class="list-group flex-grow-1 overflow-auto"></ul>
      <form id="form" class="form-inline" action="" onsubmit="submitMessage(); return false;">
        <div class="form-group">
          <input id="input" class="form-control mr-2" autocomplete="off" placeholder="Enter your message" />
        </div>
        <button type="submit" class="btn btn-primary ms-2">Send</button>
      </form>
    </div>

    <!-- User List -->
    <div class="card d-flex flex-column" style="width: 250px;">
      <div class="card-header text-secondary">
        User List
      </div>
      <ul id="user_list" class="list-group flex-grow-1 overflow-auto"></ul>
      <form id="user_form" class="p-2" onsubmit="addUser(); return false;">
        <input id="username_input" class="form-control mb-2" placeholder="Enter username" autocomplete="off" />
        <button type="submit" class="btn btn-success w-100">Add User</button>
      </form>
    </div>
  </div>
</div>

<script>
  const allowedUsers = new Set(); // ç”¨äºå­˜å‚¨å…è®¸çš„ç”¨æˆ·å

  // æ·»åŠ å½“å‰ç”¨æˆ·ååˆ°å…è®¸çš„ç”¨æˆ·åˆ—è¡¨ä¸­
  window.onload = function() {
    const currentUser = '{{ user }}';
    if (currentUser) {
      allowedUsers.add(currentUser);
      updateUserList();
    }
  };

  // å¤„ç†æ¶ˆæ¯æäº¤çš„å‡½æ•°
  function submitMessage() {
    const msgInput = document.getElementById('input');
    const username = '{{ user }}'; // ä½¿ç”¨æ¨¡æ¿ä¼ å…¥çš„ç”¨æˆ·å

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å…è®¸çš„ç”¨æˆ·åˆ—è¡¨ä¸­
    if (allowedUsers.has(username)) {
      addMessageToList(username, msgInput.value); // æ˜¾ç¤ºæ¶ˆæ¯
      msgInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
    } else {
      alert('You are not allowed to send messages. Please add your username to the list.');
    }
    
    return false; // é˜²æ­¢é¡µé¢åˆ·æ–°
  }

  // æ·»åŠ ç”¨æˆ·åˆ°ç”¨æˆ·åˆ—è¡¨
  function addUser() {
    const usernameInput = document.getElementById('username_input').value.trim();

    if (usernameInput && !allowedUsers.has(usernameInput)) {
      allowedUsers.add(usernameInput);
      updateUserList();
      document.getElementById('username_input').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
    } else if (allowedUsers.has(usernameInput)) {
      alert('User already exists.');
    } else {
      alert('Invalid input.');
    }
  }

  // ä»ç”¨æˆ·åˆ—è¡¨ä¸­åˆ é™¤ç”¨æˆ·
  function removeUser(username) {
    if (allowedUsers.has(username)) {
      allowedUsers.delete(username);
      updateUserList();
    }
  }

  // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
  function updateUserList() {
    const userList = document.getElementById('user_list');
    userList.innerHTML = ''; // æ¸…ç©ºç”¨æˆ·åˆ—è¡¨

    allowedUsers.forEach(username => {
      const userItem = document.createElement('li');
      userItem.className = 'list-group-item d-flex justify-content-between align-items-center';
      userItem.textContent = username;

      // æ¯ä¸ªç”¨æˆ·çš„åˆ é™¤æŒ‰é’®
      const removeButton = document.createElement('button');
      removeButton.className = 'btn btn-danger btn-sm';
      removeButton.textContent = 'Remove';
      removeButton.onclick = () => removeUser(username);

      userItem.appendChild(removeButton);
      userList.appendChild(userItem);
    });
  }

  // æ·»åŠ æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
  function addMessageToList(username, message) {
    const messageList = document.getElementById('message_list');
    const messageItem = document.createElement('li');
    messageItem.className = 'list-group-item';
    messageItem.textContent = `${username}: ${message}`;
    messageList.appendChild(messageItem);
  }
</script>

{% endblock %}
